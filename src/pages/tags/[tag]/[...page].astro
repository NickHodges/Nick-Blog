---
import type { GetStaticPaths, Page } from 'astro';
import type { CollectionEntry } from 'astro:content';

import Pagination from '@components/Paginator.astro';
import PostPreview from '@components/blog/PostPreview.astro';
import PageLayout from '@layouts/Base.astro';
import { getAllPosts, getUniqueTags as getPostUniqueTags, sortMDByDate as sortPostsByDate } from '@data/post';
import { getAllDelphiPosts, getUniqueTags as getDelphiUniqueTags, sortMDByDate as sortDelphiByDate } from '@data/delphi';

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const allPosts = await getAllPosts();
  const allDelphiPosts = await getAllDelphiPosts();
  const allPostsByDate = sortPostsByDate(allPosts);
  const allDelphiPostsByDate = sortDelphiByDate(allDelphiPosts);
  const allCombinedPosts = [...allPostsByDate, ...allDelphiPostsByDate];

  // Sort combined posts by date
  const allCombinedByDate = allCombinedPosts.sort((a, b) => {
    const aDate = new Date(a.data.updatedDate ?? a.data.publishDate).valueOf();
    const bDate = new Date(b.data.updatedDate ?? b.data.publishDate).valueOf();
    return bDate - aDate;
  });

  // Get unique tags from both collections
  const postTags = getPostUniqueTags(allPostsByDate);
  const delphiTags = getDelphiUniqueTags(allDelphiPostsByDate);
  const uniqueTags = [...new Set([...postTags, ...delphiTags])];

  return uniqueTags.flatMap((tag) => {
    const filterPosts = allCombinedByDate.filter((post) => post.data.tags.includes(tag));
    return paginate(filterPosts, {
      pageSize: 10,
      params: { tag },
    });
  });
};

interface Props {
  page: Page<CollectionEntry<'post'> | CollectionEntry<'delphi'>>;
}

const { page } = Astro.props;
const { tag } = Astro.params;

const meta = {
  description: `View all posts with the tag - ${tag}`,
  title: `Tag: ${tag}`,
};
---

<PageLayout meta={meta}>
  <h1 class='title mb-6 flex items-center'>
    <a class='text-accent sm:hover:underline' href='/tags/'>Tags</a>
    <span class='me-3 ms-2'>â†’</span>
    <span class='text-xl'>#{tag}</span>
  </h1>
  <section aria-label='Blog post list'>
    <ul class='space-y-8'>
      {
        page.data.map((p) => (
          <li class='flex flex-col flex-wrap gap-2 sm:flex-row [&_q]:basis-full'>
            <PostPreview as='h2' post={p} withDesc />
          </li>
        ))
      }
    </ul>
    <Pagination page={page} />
  </section>
</PageLayout>
